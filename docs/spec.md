## ソフトウェア企画書: gnb-envswap

## 1. プログラムの名称

**gnb-envswap** (ジーエヌビー・エンブスワップ)

* **コマンド名:** `gnb-envswap [SUBCOMMAND]`
* **由来:** 作成者(gennobou) + 環境変数(env) + 交換(swap)

## 2. 目的

PowerShellセッションで利用する環境変数を、TUI（テキストベースのUI）によるインタラクティブなメニューを通じて、**素早く・安全に**切り替えるCLIツールを提供する。
複数のAPIキーや接続先情報を切り替えて開発・運用する作業を効率化する。

## 3. 機能

* **設定ファイルの編集 (`edit`サブコマンド):**
  * `edit local` (または `edit`): ワークディレクトリの `.env.swap.toml` を開く。
  * `edit global`: ホームディレクトリの `.env.swap.toml` を開く。
  * ファイルが存在しない場合は空のファイルとして自動作成する。
  * 編集には、`.toml` ファイルにOSで関連付けられたデフォルトのアプリケーションを使用する。
  * ファイル作成に失敗した場合は、エラーメッセージを表示して終了する。
* **設定ファイルの読み込みとマージ (サブコマンドなしの場合):**

  * 実行時のワークディレクトリとホームディレクトリの `.env.swap.toml` を順に探索。
  * 両方存在する場合は**ワークディレクトリ側を優先してマージ**するが、
    同一キーが重複しても上書きせず**両方を統合表示**（TUI上で選択肢が増える形）。
  * どちらも存在しない、または中身が空の場合は、多言語対応のエラーメッセージを標準エラー出力に表示して終了。
* **インタラクティブTUI (サブコマンドなしの場合):**

  * 矢印キーとEnterキーで操作可能。
  * TUIのウィンドウは、表示する項目数に応じて高さを動的に調整し、画面中央に表示。
  * TUIの下部には、現在の状況で利用可能な操作キーのヒントを多言語対応で表示。
* **UIの国際化 (i18n):**

  * OSロケールが `ja` で始まる場合（例: `ja_JP.UTF-8`）、UIメッセージを日本語表示。
  * それ以外のロケールでは英語表示（デフォルト）。
* **二段階選択:**

  1. 環境変数名の選択
  2. ラベルの選択（同一変数に複数値がある場合）
* **値の非表示:**
  値（APIキーなど）は画面に一切表示しない。
* **PowerShellコマンド出力:**
  選択後、`$Env:VAR_NAME = 'value'` 形式で標準出力に出力。
  値に `'` が含まれる場合は `'"'` で囲むなど、`.env` 形式と同等のエスケープルールに準拠する。
  （`dotenvy` や `envfile` と同じ文字列処理基準）

## 4. 開発言語

**Rust**

* 単一実行ファイル配布が容易。
* 高速起動。
* 安全なメモリ管理。
* `ratatui`, `crossterm` による堅牢なTUI構築が可能。

## 5. 実行環境

* **OS:** Windows 10 / 11
* **シェル:** PowerShell 5.1 / 7.x
* **配布:** Scoop

## 6. 主要ライブラリ (Rust)

| ライブラリ名                 | 用途               |
| :--------------------- | :--------------- |
| `clap`                 | コマンドライン引数の解析     |
| `ratatui`, `crossterm` | TUI構築、キー入力、端末制御  |
| `serde`, `toml`        | 設定ファイルのデシリアライズ   |
| `dirs`                 | ホームディレクトリ取得      |
| `sys-locale`           | ロケール判定           |
| `serde_json`           | i18nメッセージ定義の読み込み |
| `open`                 | 外部アプリケーションでのファイル表示 |

---

## 7. 対象ユーザー

* 複数環境を切り替える開発者

---

## 8. 非機能要件

* **パフォーマンス:** 起動からTUI表示まで1秒以内
* **ロバスト性:**

  * 設定ファイルが未発見または空の場合は、多言語対応のローカライズされたエラーメッセージを標準エラー出力に表示して終了。
  * TUI実行中にエラー発生時は速やかに終了し、端末を通常モードに復帰 (`disable_raw_mode`)。
* **利便性:**
  * キーボード操作のみで完結。
  * TUIは項目数に応じて高さを動的に調整し、ターミナル画面を不必要に専有しない。
  * 状況に応じた操作キーのヒントを常時表示し、マニュアルを参照せずとも直感的な操作を可能にする。
* **セキュリティ:**

  * `.env.swap.toml` はAPIキー等を含むが、機密等級は一般的な開発用`.env`と同等扱いとする。
  * ファイル権限を制限（所有者読み取り推奨）。
  * 値は画面・ログに一切出力しない。
* **互換性:** Windows Terminalで表示崩れないこと。
* **国際化:**

  * メッセージは `i18n/messages.json` から読み込む。
  * 英語をデフォルト、日本語は `ja` ロケール判定時に選択。

---

## 9. アーキテクチャ概要

### 構成

1. **CLI Parser**
   * `clap` を利用してコマンドライン引数を解析。
   * `edit` サブコマンドが指定された場合はファイル編集フローを実行し、それ以外の場合はTUIモードを開始する。

2. **Config Loader**

   * `dirs::home_dir()` と `std::env::current_dir()` でファイル特定。
   * 双方存在時は「同名キーを統合」してマージ。
   * 存在しない場合はエラー終了。

3. **i18n Manager**

   * `sys-locale` でロケールを取得。
   * `starts_with("ja")` で判定。
   * `i18n/messages.json` から対応言語メッセージをロード。

3. **TUI Engine**

   * `ratatui` で状態管理と再描画。
   * エラー発生時は端末を復旧して終了。

4. **Output Generator**

   * `dotenvy` 同等のエスケープルールでPowerShell文を生成。
   * `println!` で `$Env:NAME = 'VALUE'` 出力。

---

### 設定ファイル形式

```toml
[API_KEY]
[[API_KEY.values]]
label = "開発環境 (Dev) 🚀"
value = "dev_api_key_xxxxxxxxx"

[[API_KEY.values]]
label = "本番 (Prod)"
value = "prod_api_key_yyyyyyyy"

[DB_HOST]
[[DB_HOST.values]]
label = "ローカルDB"
value = "localhost"
```

同名キーが複数ファイルに存在する場合、すべての `values` が結合されて表示される。

---

## 10. 開発スケジュール（3週間）

| 週      | タスク               | 成果物                                  |
| :----- | :---------------- | :----------------------------------- |
| Week 1 | 設定読込・マージ・テスト実装    | TOMLローダー、単体テスト                       |
| Week 2 | TUI・i18n実装        | 二段階選択UI、JSONメッセージ処理                  |
| Week 3 | PowerShell連携・CI構築 | 出力生成、GitHub Actionsリリース、Scoop用マニフェスト |

---

## 11. テスト計画

* **ユニットテスト:**

  * 設定マージ（重複統合）の検証
  * `.env.swap.toml` 不存在・不正構文時の動作
  * ロケール判定（`ja`, `en`）モックテスト
  * 値のエスケープ処理テスト
  * Unicodeラベル（絵文字含む）表示確認

* **自動E2Eテスト:**

  * `expect` 互換テストでTUI動作確認
  * 出力が正しいPowerShellコマンド形式であるか検証

* **手動E2E:**

  * Windows 10/11、PowerShell 5.1/7.x
  * 言語設定を切り替え日本語/英語表示確認

---

## 12. デプロイメント方法

1. **リポジトリ:**

   * GitHub 公開 (`gennobou/gnb-envswap`)
   * `LICENSE` (MIT または Apache-2.0)
   * `README.md`（英）と `README.ja.md`（日）
   * 設計書・企画書を `docs/` に配置

2. **ビルドとリリース:**

   * GitHub ActionsでWindows用バイナリを生成。
   * タグ付きリリース時にZIPを添付。
   * ZIP直下に `gnb-envswap.exe` を配置。

3. **Scoop公開:**

   * 個人Bucket例：`github.com/gennobou/scoop-bucket`
   * `gnb-envswap.json` にURL・ハッシュ・`bin`=`"gnb-envswap.exe"` を記述。
   * インストール例：

     ```powershell
     scoop bucket add gennobou https://github.com/gennobou/scoop-bucket
     scoop install gennobou/gnb-envswap
     ```


